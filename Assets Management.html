<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlueFactory — Assets Management</title>

  <!-- Icons & Charts & Exports -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase compat (quick start) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --blue-900: #0b3d91;
      --blue-700: #1464c9;
      --blue-500: #2a9df4;
      --bg: #f4f7fb;
      --panel: #ffffff;
      --muted: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
    }
    [data-theme="dark"]{
      --bg: #0f1724;
      --panel: #0b1220;
      --muted: #9ca3af;
      --blue-900: #071733;
      --blue-700: #0a3a6b;
      --blue-500: #1f6fb3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg), #e9f2ff 300px);
      color: #0b1220;
      transition: background .35s, color .35s;
      min-height:100vh;
      --sidebar-w:260px;
    }
    [data-theme="dark"] body{ color:#e6eef8; }

    .app{ display:flex; min-height:100vh; }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-w);
      background: linear-gradient(180deg,var(--blue-900), var(--blue-700));
      color:#fff; padding:18px; display:flex; flex-direction:column; gap:12px;
      position:fixed; left:0; top:0; bottom:0; box-shadow:0 6px 24px rgba(10,25,60,0.12); overflow:hidden;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.05rem; }
    .nav-links{ display:flex; flex-direction:column; gap:6px; margin-top:6px; overflow-y: auto; /* تفعيل السكرول */ padding-right: 5px; /* عشان يبان السكرول */ }
    /* شكل السكرول في المتصفحات الحديثة */
.nav-links::-webkit-scrollbar {
  width: 6px;
}

.nav-links::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}
    .nav-link{
      display:flex; align-items:center; gap:12px;
      padding:10px; border-radius:10px; color:rgba(255,255,255,0.9); text-decoration:none;
      font-weight:600; font-size:0.95rem;
    }
    .nav-link:hover, .nav-link.active{
      background: rgba(255,255,255,0.06);
      transform:translateX(6px);
    }
    .sidebar-footer{ margin-top:auto; font-size:.85rem; color:rgba(255,255,255,0.85) }

    /* Main */
    .main{ margin-left:var(--sidebar-w); padding:22px; width:calc(100% - var(--sidebar-w)); }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .search{ flex:1; max-width:540px; display:flex; gap:8px; align-items:center; }
    .search input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); background:var(--panel); box-shadow:0 2px 8px rgba(11,18,32,0.04); }
    .controls{ display:flex; gap:10px; align-items:center; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer; border:none; font-weight:600; }
    .btn-primary{ background:linear-gradient(90deg,var(--blue-700),var(--blue-500)); color:#fff; box-shadow: 0 8px 18px rgba(42,157,244,0.14); }
    .btn-ghost{ background:transparent; border:1px solid rgba(15,23,42,0.06); color:var(--muted); }

    .grid{ display:grid; grid-template-columns: repeat(12,1fr); gap:18px; align-items:start; }
    .card{ background:var(--panel); border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(16,24,40,0.04); transition:transform .28s, box-shadow .28s; overflow:hidden; }
    .card:hover{ transform: translateY(-6px); box-shadow: 0 16px 36px rgba(16,24,40,0.08); }

    h2{ margin:0; font-size:1.2rem }
    .small-muted{ color:var(--muted); font-size:.92rem }

    /* layout columns */
    .left-col{ grid-column: span 7 }
    .right-col{ grid-column: span 5 }

    /* table */
    table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    thead th{ text-align:left; color:var(--muted); font-weight:700; padding:10px 6px; font-size:.86rem }
    tbody tr{ transition: background .18s, transform .18s; border-bottom:1px solid rgba(0,0,0,0.04); }
    tbody tr:hover{ background: linear-gradient(90deg, rgba(42,157,244,0.03), rgba(10,25,60,0.02)); transform: translateX(4px); }
    td{ padding:12px 6px; vertical-align:middle }

    .chip{ display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--blue-700);font-weight:700;font-size:.85rem }

    /* modal (simple) */
    .modal-backdrop{ position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:920px; max-width:95%; max-height:90%; overflow:auto; background:var(--panel); border-radius:12px; padding:18px; box-shadow:0 12px 48px rgba(0,0,0,0.3); }

    .form-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    label{ font-weight:600; display:block; margin-bottom:6px; }
    input, select, textarea{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; width:100%; background:#fff; }

    .list-item{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; }
    .product-thumb{ width:56px; height:56px; border-radius:8px; background:#eef7ff; display:flex; align-items:center; justify-content:center; color:var(--blue-700) }

    /* small screens */
    @media (max-width:1000px){
      .left-col{ grid-column: span 12 } .right-col{ grid-column: span 12 }
    }

    /* animation */
    @keyframes popIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
    .card{ animation: popIn .45s ease both }
  </style>
</head>
<body data-theme="light">

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Sidebar">
    <div class="brand"><i class="fa-solid fa-industry"></i><span>FinMate</span></div>

    <nav class="nav-links" aria-label="Main navigation">
      <a href="dashboard.html" class="nav-link active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
      <a href="Invoices.html" class="nav-link"><i class="fa-solid fa-file-invoice-dollar"></i> Invoices</a>
      <a href="Inventory.html" class="nav-link"><i class="fa-solid fa-boxes-stacked"></i> Inventory</a>
      <a href="Reports.html" class="nav-link"><i class="fa-solid fa-chart-line"></i> Reports</a>
      <a href="suppliers.html" class="nav-link"><i class="fa-solid fa-truck-field"></i> Suppliers </a>
      <a href="Chart of Accounts.html" class="nav-link"><i class="fa-solid fa-book"></i> Chart of Accounts </a>
      <a href="Journal Entries.html" class="nav-link"><i class="fa-solid fa-clipboard-list"></i> Journal Entries </a>
      <a href="Customers.html" class="nav-link"><i class="fa-solid fa-user-tie"></i> Customers</a>
      <a href="Purchase Orders.html" class="nav-link"><i class="fa-solid fa-file-circle-check"></i> Purchase Orders</a>
      <a href="Sales Orders.html" class="nav-link"><i class="fa-solid fa-file-contract"></i> Sales Orders</a>
      <a href="Payments.html" class="nav-link"><i class="fa-solid fa-money-bill-transfer"></i> Payments</a>
      <a href="Payroll.html" class="nav-link"><i class="fa-solid fa-money-check-dollar"></i> Payroll</a>
      <a href="Tax Management.html" class="nav-link"><i class="fa-solid fa-receipt"></i> Tax Management</a>
      <a href="Assets Management.html" class="nav-link"><i class="fa-solid fa-building-columns"></i> Assets Management</a>
      <a href="Audit Logs.html" class="nav-link"><i class="fa-solid fa-magnifying-glass-chart"></i> Audit Logs</a>
      <a href="Multi-Currency & Exchange Rates.html" class="nav-link"><i class="fa-solid fa-coins"></i> Multi-Currency & Exchange Rates</a>
      <a href="Notifications Center.html" class="nav-link"><i class="fa-solid fa-bell"></i> Notifications Center</a>
      <a href="Settings.html" class="nav-link"><i class="fa-solid fa-cogs"></i> Settings</a>
    </nav>
    

    <div class="sidebar-footer">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center"><i class="fa-solid fa-circle-info"></i></div>
        <div>
          <div style="font-weight:700">Factory #12</div>
          <div style="font-size:.85rem;opacity:.9">Plan: Enterprise</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" role="main">

    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <h2>Assets Management</h2>
        <div class="small-muted">Manage fixed assets, depreciation, maintenance & reporting</div>
      </div>

      <div class="controls">
        <div class="search">
          <input id="globalSearch" placeholder="Search by name, tag, category, or department..." />
        </div>
        <button class="btn icon-btn" title="Notifications"><i class="fa-regular fa-bell"></i></button>
        <button class="btn icon-btn" id="themeToggle" title="Toggle theme"><i class="fa-regular fa-moon"></i></button>
        <button class="btn btn-primary" id="openAddAssetBtn"><i class="fa-solid fa-plus"></i> New Asset</button>
      </div>
    </div>

    <section class="grid">

      <!-- LEFT: Table & filters -->
      <div class="left-col card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Asset Register</strong>
            <div class="small-muted">List of all capital assets</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" onclick="exportAssetsExcel()">Export Excel</button>
            <button class="btn btn-ghost" onclick="exportAssetsPDF()">Export PDF</button>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin:12px 0;align-items:center">
          <select id="filterCategory" style="width:180px;padding:8px;border-radius:8px;border:1px solid #ddd">
            <option value="">All categories</option>
          </select>
          <select id="filterStatus" style="width:160px;padding:8px;border-radius:8px;border:1px solid #ddd">
            <option value="">All statuses</option>
            <option value="Active">Active</option>
            <option value="Disposed">Disposed</option>
            <option value="Under Maintenance">Under Maintenance</option>
          </select>
          <label class="small-muted" style="margin-left:auto">
            Show disposed <input type="checkbox" id="showDisposed" style="margin-left:6px" />
          </label>
        </div>

        <div style="overflow:auto; max-height:520px">
          <table>
            <thead>
              <tr><th>#</th><th>Name</th><th>Tag / Serial</th><th>Category</th><th>Purchase Value</th><th>Book Value</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="assetsTableBody"></tbody>
          </table>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="small-muted" id="assetsSummary">0 assets • Total purchase: $0</div>
          <div>
            <button class="btn btn-ghost" onclick="prevPage()">Prev</button>
            <button class="btn btn-ghost" onclick="nextPage()">Next</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Details, charts, maintenance -->
      <div class="right-col card">
        <div>
          <strong>Asset Details & Tools</strong>
          <div class="small-muted">Select an asset to view details, depreciation schedule & maintenance</div>
        </div>

        <div style="margin-top:12px">
          <div id="assetPlaceholder" class="small-muted">No asset selected</div>

          <div id="assetDetails" style="display:none;margin-top:12px">
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div style="width:100%">
                <div style="display:flex;justify-content:space-between;align-items:start">
                  <div>
                    <h3 id="detailName" style="margin:0"></h3>
                    <div class="small-muted" id="detailMeta"></div>
                  </div>
                  <div style="text-align:right">
                    <div class="chip" id="detailStatus">Active</div>
                    <div style="margin-top:8px"><button class="btn btn-ghost" onclick="openEditSelected()">Edit</button></div>
                  </div>
                </div>

                <div style="margin-top:12px;display:flex;gap:12px">
                  <div style="flex:1">
                    <div class="small-muted">Purchase value</div>
                    <div style="font-weight:700" id="detailPurchase">$0</div>
                  </div>
                  <div style="flex:1">
                    <div class="small-muted">Accumulated Depreciation</div>
                    <div style="font-weight:700" id="detailAccum">$0</div>
                  </div>
                  <div style="flex:1">
                    <div class="small-muted">Book Value</div>
                    <div style="font-weight:700" id="detailBook">$0</div>
                  </div>
                </div>

                <hr style="margin:12px 0" />

                <div>
                  <strong>Depreciation Schedule (preview)</strong>
                  <div style="max-height:160px;overflow:auto;margin-top:8px">
                    <table style="width:100%;font-size:.9rem">
                      <thead><tr><th>Period</th><th>Depreciation</th><th>Accumulated</th><th>Book Value</th></tr></thead>
                      <tbody id="deprSchedule"></tbody>
                    </table>
                  </div>
                </div>

                <hr style="margin:12px 0" />

                <div>
                  <strong>Maintenance Logs</strong>
                  <div style="margin-top:8px">
                    <div id="maintenanceList"></div>
                    <div style="margin-top:8px">
                      <button class="btn btn-primary" onclick="openAddMaintenance()">Add Maintenance</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr style="margin:12px 0" />

            <div style="display:flex;gap:12px;align-items:center">
              <div style="width:50%">
                <canvas id="categoryDonut" style="max-height:200px"></canvas>
              </div>
              <div style="width:50%">
                <canvas id="bookValueLine" style="max-height:200px"></canvas>
              </div>
            </div>

          </div>
        </div>
      </div>

    </section>

    <div style="margin-top:18px" class="card">
      <strong>Activity</strong>
      <div class="small-muted" id="activityLog">No changes yet</div>
    </div>

    <div style="margin-top:12px" class="page-footer small-muted">© 2025 BlueFactory — Accounting for Manufacturers</div>

  </main>
</div>

<!-- Simple modal templates -->
<div id="modalRoot" style="display:none;"></div>

<script>
/* ===========================
   Firebase config - replace with your values
   =========================== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===========================
   Theme handling
   =========================== */
(function(){
  const saved = localStorage.getItem('bf_theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');
  document.getElementById('themeToggle').innerHTML = saved === 'dark' ? '<i class="fa-regular fa-sun"></i>' : '<i class="fa-regular fa-moon"></i>';
})();
document.getElementById('themeToggle').addEventListener('click', function(){
  const dt = document.documentElement;
  const cur = dt.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  const nxt = cur === 'dark' ? 'light' : 'dark';
  dt.setAttribute('data-theme', nxt);
  localStorage.setItem('bf_theme', nxt);
  this.innerHTML = nxt === 'dark' ? '<i class="fa-regular fa-sun"></i>' : '<i class="fa-regular fa-moon"></i>';
});

/* ===========================
   State & pagination
   =========================== */
let assets = []; // local cache
let selectedAsset = null;
let currentPage = 0;
const pageSize = 12;

/* DOM refs */
const assetsTableBody = document.getElementById('assetsTableBody');
const filterCategory = document.getElementById('filterCategory');
const filterStatus = document.getElementById('filterStatus');
const showDisposed = document.getElementById('showDisposed');
const globalSearch = document.getElementById('globalSearch');
const assetsSummary = document.getElementById('assetsSummary');
const activityLog = document.getElementById('activityLog');
const assetPlaceholder = document.getElementById('assetPlaceholder');
const assetDetails = document.getElementById('assetDetails');

/* Charts */
let donutChart = null;
let lineChart = null;

/* ===========================
   Utilities
   =========================== */
function logActivity(text){
  activityLog.textContent = (new Date().toLocaleString()) + ': ' + text;
}

/* safe escape */
function esc(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;'}[c])); }

/* ===========================
   CRUD: Assets (Firestore)
   =========================== */
async function loadAssets(){
  try {
    const snapshot = await db.collection('assets').orderBy('name').get();
    assets = [];
    snapshot.forEach(doc => assets.push({ id: doc.id, ...doc.data() }));
    // local transforms
    assets.forEach(a => {
      a.purchaseValue = Number(a.purchaseValue || 0);
      a.salvageValue = Number(a.salvageValue || 0);
      a.usefulLife = Number(a.usefulLife || 0);
    });
    renderAssets();
    populateCategoryFilter();
    renderCharts();
    logActivity('Loaded assets: ' + assets.length);
  } catch (err){
    console.error(err); alert('Error loading assets (check console)');
  }
}

/* render assets table with pagination & filters */
function renderAssets(){
  const q = globalSearch.value.trim().toLowerCase();
  const cat = filterCategory.value;
  const status = filterStatus.value;
  const showD = showDisposed.checked;

  let list = assets.filter(a => {
    if(!showD && a.status === 'Disposed') return false;
    if(cat && a.category !== cat) return false;
    if(status && a.status !== status) return false;
    if(q){
      const hay = [a.name, a.tag, a.category, a.department, a.location].join(' ').toLowerCase();
      return hay.includes(q);
    }
    return true;
  });

  const total = list.length;
  const start = currentPage * pageSize;
  const paged = list.slice(start, start + pageSize);

  assetsTableBody.innerHTML = '';
  paged.forEach((a, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${start + idx + 1}</td>
      <td><strong>${esc(a.name)}</strong><div class="small-muted">${esc(a.department || '')} • ${esc(a.location || '')}</div></td>
      <td>${esc(a.tag || '')}</td>
      <td>${esc(a.category || '')}</td>
      <td>$${a.purchaseValue.toLocaleString()}</td>
      <td>$${computeBookValue(a, new Date()).toLocaleString()}</td>
      <td>${a.status || 'Active'}</td>
      <td>
        <button class="btn btn-ghost" onclick='selectAsset("${a.id}")'><i class="fa-solid fa-eye"></i></button>
        <button class="btn btn-ghost" onclick='openEditAsset("${a.id}")'><i class="fa-solid fa-pen"></i></button>
        <button class="btn btn-ghost" onclick='deleteAsset("${a.id}")'><i class="fa-solid fa-trash"></i></button>
      </td>
    `;
    assetsTableBody.appendChild(tr);
  });

  assetsSummary.textContent = `${total} assets • Showing ${start+1}-${Math.min(start+pageSize,total)} • Total purchase: $${assets.reduce((s,a)=>s+a.purchaseValue,0).toLocaleString()}`;
}

/* compute straight-line or declining-balance book value for a given asset and date */
function computeBookValue(asset, atDate){
  const pv = Number(asset.purchaseValue || 0);
  const salvage = Number(asset.salvageValue || 0);
  const life = Number(asset.usefulLife || 0);
  if(!life || life <= 0) return pv;
  const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : new Date();
  const monthsElapsed = Math.max(0, monthDiff(purchaseDate, atDate));
  // For simplicity, compute annual periods (years elapsed)
  const yearsElapsed = monthsElapsed / 12;
  if((asset.deprMethod || 'straight').toLowerCase() === 'declining'){
    // Double-declining balance approx
    const rate = 2 / life;
    let bv = pv;
    let acc = 0;
    for(let y=0;y<Math.floor(yearsElapsed);y++){
      const dep = bv * rate;
      acc += dep;
      bv -= dep;
      if(bv < salvage){ bv = salvage; break; }
    }
    return Math.max(Math.round(bv), salvage);
  } else {
    // Straight-line
    const annual = (pv - salvage) / life;
    const acc = Math.min((annual * yearsElapsed), (pv - salvage));
    const bv = pv - acc;
    return Math.round(Math.max(bv, salvage));
  }
}
function monthDiff(d1, d2){
  return (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth());
}

/* select asset to show details */
async function selectAsset(id){
  selectedAsset = assets.find(a=>a.id===id);
  if(!selectedAsset) { alert('Asset not found'); return; }
  assetPlaceholder.style.display = 'none';
  assetDetails.style.display = 'block';
  document.getElementById('detailName').textContent = selectedAsset.name;
  document.getElementById('detailMeta').textContent = `${selectedAsset.tag || ''} • ${selectedAsset.category || ''} • ${selectedAsset.department || ''}`;
  document.getElementById('detailPurchase').textContent = '$' + (selectedAsset.purchaseValue||0).toLocaleString();
  // compute accumulated depreciation (simple for demo: years elapsed * annual)
  const acc = computeAccumulatedDep(selectedAsset, new Date());
  const bv = computeBookValue(selectedAsset, new Date());
  document.getElementById('detailAccum').textContent = '$' + acc.toLocaleString();
  document.getElementById('detailBook').textContent = '$' + bv.toLocaleString();
  document.getElementById('detailStatus').textContent = selectedAsset.status || 'Active';
  renderDepSchedule(selectedAsset);
  await loadMaintenance(selectedAsset.id);
}

/* Open add/edit modal */
function openAddAssetModal(initial = {}) {
  const html = `
  <div class="modal-backdrop" id="assetModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>${initial.id ? 'Edit Asset' : 'Add Asset'}</h3>
      <div style="margin-top:12px;">
        <div class="form-row">
          <div style="flex:1"><label>Name</label><input id="m_name" value="${esc(initial.name||'')}" /></div>
          <div style="width:160px"><label>Tag / Serial</label><input id="m_tag" value="${esc(initial.tag||'')}" /></div>
        </div>
        <div class="form-row">
          <div style="flex:1"><label>Category</label><input id="m_category" value="${esc(initial.category||'')}" /></div>
          <div style="width:160px"><label>Department</label><input id="m_department" value="${esc(initial.department||'')}" /></div>
        </div>
        <div class="form-row">
          <div style="width:160px"><label>Purchase Date</label><input id="m_purchaseDate" type="date" value="${initial.purchaseDate? new Date(initial.purchaseDate).toISOString().slice(0,10):''}" /></div>
          <div style="width:160px"><label>Purchase Value</label><input id="m_purchaseValue" type="number" step="0.01" value="${initial.purchaseValue||0}" /></div>
          <div style="width:160px"><label>Salvage Value</label><input id="m_salvage" type="number" step="0.01" value="${initial.salvageValue||0}" /></div>
        </div>
        <div class="form-row">
          <div style="width:180px"><label>Useful Life (years)</label><input id="m_usefulLife" type="number" step="1" value="${initial.usefulLife||5}" /></div>
          <div style="width:220px"><label>Depreciation Method</label>
            <select id="m_deprMethod">
              <option value="straight" ${initial.deprMethod === 'straight' ? 'selected':''}>Straight-line</option>
              <option value="declining" ${initial.deprMethod === 'declining' ? 'selected':''}>Declining balance</option>
            </select>
          </div>
          <div style="width:160px"><label>Status</label>
            <select id="m_status">
              <option value="Active" ${initial.status === 'Active' ? 'selected':''}>Active</option>
              <option value="Under Maintenance" ${initial.status === 'Under Maintenance' ? 'selected':''}>Under Maintenance</option>
              <option value="Disposed" ${initial.status === 'Disposed' ? 'selected':''}>Disposed</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" id="saveAssetModalBtn">${initial.id ? 'Update' : 'Create'}</button>
        </div>
      </div>
    </div>
  </div>
  `;
  document.getElementById('modalRoot').innerHTML = html;
  document.getElementById('modalRoot').style.display = 'block';

  document.getElementById('saveAssetModalBtn').addEventListener('click', async () => {
    const payload = {
      name: document.getElementById('m_name').value.trim(),
      tag: document.getElementById('m_tag').value.trim(),
      category: document.getElementById('m_category').value.trim(),
      department: document.getElementById('m_department').value.trim(),
      purchaseDate: document.getElementById('m_purchaseDate').value ? new Date(document.getElementById('m_purchaseDate').value).toISOString() : null,
      purchaseValue: Number(document.getElementById('m_purchaseValue').value) || 0,
      salvageValue: Number(document.getElementById('m_salvage').value) || 0,
      usefulLife: Number(document.getElementById('m_usefulLife').value) || 0,
      deprMethod: document.getElementById('m_deprMethod').value,
      status: document.getElementById('m_status').value,
      location: initial.location || '',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      if(initial.id){
        await db.collection('assets').doc(initial.id).update(payload);
        logActivity('Asset updated: ' + payload.name);
      } else {
        payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('assets').add(payload);
        logActivity('Asset created: ' + payload.name);
      }
      closeModal();
      await loadAssets();
    } catch (err){
      console.error(err); alert('Save failed');
    }
  });
}

function closeModal(){
  document.getElementById('modalRoot').innerHTML = '';
  document.getElementById('modalRoot').style.display = 'none';
}

/* open add with blank */
document.getElementById('openAddAssetBtn').addEventListener('click', ()=> openAddAssetModal({}));

/* open edit */
function openEditAsset(id){
  const a = assets.find(x=>x.id===id);
  if(!a) { alert('Asset not found'); return; }
  openAddAssetModal(a);
}
function openEditSelected(){
  if(!selectedAsset) return alert('Select an asset first');
  openAddAssetModal(selectedAsset);
}

/* delete */
async function deleteAsset(id){
  if(!confirm('Delete asset?')) return;
  try {
    await db.collection('assets').doc(id).delete();
    logActivity('Asset deleted');
    await loadAssets();
  } catch (err){ console.error(err); alert('Delete failed'); }
}

/* pagination */
function prevPage(){ if(currentPage>0){ currentPage--; renderAssets(); } }
function nextPage(){ currentPage++; renderAssets(); }

/* ===========================
   Depreciation helpers & schedule render
   =========================== */
function computeAccumulatedDep(asset, atDate){
  const pv = Number(asset.purchaseValue || 0);
  const salvage = Number(asset.salvageValue || 0);
  const life = Number(asset.usefulLife || 0);
  if(!life) return 0;
  const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : new Date();
  const yearsElapsed = Math.max(0, monthDiff(purchaseDate, atDate) / 12);
  if((asset.deprMethod || 'straight').toLowerCase() === 'declining'){
    const rate = 2 / life;
    let bv = pv;
    let acc = 0;
    for(let y=0;y<Math.floor(yearsElapsed);y++){
      const dep = bv * rate;
      acc += dep;
      bv -= dep;
      if(bv < salvage){ bv = salvage; break; }
    }
    return Math.round(acc);
  } else {
    const annual = (pv - salvage) / life;
    const acc = Math.min(annual * yearsElapsed, (pv - salvage));
    return Math.round(acc);
  }
}

function renderDepSchedule(asset){
  const tbody = document.getElementById('deprSchedule');
  tbody.innerHTML = '';
  const pv = Number(asset.purchaseValue||0);
  const salvage = Number(asset.salvageValue||0);
  const life = Number(asset.usefulLife||0) || 1;
  const method = asset.deprMethod || 'straight';
  let acc = 0;
  let bv = pv;
  for(let year=1; year<=Math.min(12, life); year++){
    let dep = 0;
    if(method === 'declining'){
      const rate = 2 / life;
      dep = Math.round(bv * rate);
      bv -= dep;
      if(bv < salvage){ dep -= (salvage - bv); bv = salvage; }
    } else {
      const annual = (pv - salvage) / life;
      dep = Math.round(annual);
      acc += dep;
      bv = Math.round(pv - acc);
    }
    acc = Math.round((pv - bv));
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>Year ${year}</td><td>$${dep.toLocaleString()}</td><td>$${acc.toLocaleString()}</td><td>$${bv.toLocaleString()}</td>`;
    tbody.appendChild(tr);
    if(bv <= salvage) break;
  }
}

/* ===========================
   Maintenance logs (per asset)
   =========================== */
async function loadMaintenance(assetId){
  const container = document.getElementById('maintenanceList');
  container.innerHTML = '<div class="small-muted">Loading maintenance...</div>';
  try {
    const snapshot = await db.collection('assets').doc(assetId).collection('maintenance').orderBy('date','desc').get();
    container.innerHTML = '';
    if(snapshot.empty) container.innerHTML = '<div class="small-muted">No maintenance logs</div>';
    snapshot.forEach(doc => {
      const m = doc.data();
      const el = document.createElement('div');
      el.className = 'list-item';
      el.innerHTML = `<div style="flex:1"><div style="font-weight:700">${esc(m.title)}</div><div class="small-muted">${new Date(m.date).toLocaleDateString()} • ${esc(m.provider||'')}</div><div style="margin-top:6px">${esc(m.notes||'')}</div></div>
                      <div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-ghost" onclick='editMaintenance("${assetId}","${doc.id}")'>Edit</button><button class="btn btn-ghost" onclick='deleteMaintenance("${assetId}","${doc.id}")'>Delete</button></div>`;
      container.appendChild(el);
    });
  } catch(err){ console.error(err); container.innerHTML = '<div class="small-muted">Failed to load</div>'; }
}

function openAddMaintenance(){
  if(!selectedAsset) return alert('Select an asset first');
  const html = `
  <div class="modal-backdrop" id="maintModal">
    <div class="modal">
      <h3>Add Maintenance</h3>
      <div style="margin-top:12px;">
        <div class="form-row"><div style="flex:1"><label>Title</label><input id="m_title" /></div></div>
        <div class="form-row"><div style="flex:1"><label>Provider</label><input id="m_provider" /></div><div style="width:160px"><label>Date</label><input id="m_date" type="date" /></div></div>
        <div class="form-row"><div style="flex:1"><label>Notes</label><textarea id="m_notes" rows="4"></textarea></div></div>
        <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="saveMaintBtn">Save</button></div>
      </div>
    </div>
  </div>`;
  document.getElementById('modalRoot').innerHTML = html; document.getElementById('modalRoot').style.display = 'block';
  document.getElementById('saveMaintBtn').addEventListener('click', async ()=>{
    const payload = { title: document.getElementById('m_title').value.trim(), provider: document.getElementById('m_provider').value.trim(), date: document.getElementById('m_date').value ? new Date(document.getElementById('m_date').value).toISOString() : new Date().toISOString(), notes: document.getElementById('m_notes').value.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    try {
      await db.collection('assets').doc(selectedAsset.id).collection('maintenance').add(payload);
      closeModal();
      await loadMaintenance(selectedAsset.id);
      logActivity('Maintenance added');
    } catch(err){ console.error(err); alert('Failed to add'); }
  });
}

/* edit maintenance */
async function editMaintenance(assetId, maintId){
  try {
    const doc = await db.collection('assets').doc(assetId).collection('maintenance').doc(maintId).get();
    if(!doc.exists) return alert('Not found');
    const m = doc.data();
    const html = `
    <div class="modal-backdrop" id="maintModal">
      <div class="modal">
        <h3>Edit Maintenance</h3>
        <div style="margin-top:12px;">
          <div class="form-row"><div style="flex:1"><label>Title</label><input id="m_title" value="${esc(m.title||'')}" /></div></div>
          <div class="form-row"><div style="flex:1"><label>Provider</label><input id="m_provider" value="${esc(m.provider||'')}" /></div><div style="width:160px"><label>Date</label><input id="m_date" type="date" value="${m.date? new Date(m.date).toISOString().slice(0,10):''}" /></div></div>
          <div class="form-row"><div style="flex:1"><label>Notes</label><textarea id="m_notes" rows="4">${esc(m.notes||'')}</textarea></div></div>
          <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="saveMaintBtn">Save</button></div>
        </div>
      </div>
    </div>`;
    document.getElementById('modalRoot').innerHTML = html; document.getElementById('modalRoot').style.display = 'block';
    document.getElementById('saveMaintBtn').addEventListener('click', async ()=>{
      const payload = { title: document.getElementById('m_title').value.trim(), provider: document.getElementById('m_provider').value.trim(), date: document.getElementById('m_date').value ? new Date(document.getElementById('m_date').value).toISOString() : new Date().toISOString(), notes: document.getElementById('m_notes').value.trim(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      try {
        await db.collection('assets').doc(assetId).collection('maintenance').doc(maintId).update(payload);
        closeModal();
        await loadMaintenance(assetId);
        logActivity('Maintenance updated');
      } catch(err){ console.error(err); alert('Update failed'); }
    });
  } catch(err){ console.error(err); alert('Error'); }
}

async function deleteMaintenance(assetId, maintId){
  if(!confirm('Delete maintenance entry?')) return;
  try {
    await db.collection('assets').doc(assetId).collection('maintenance').doc(maintId).delete();
    await loadMaintenance(assetId);
    logActivity('Maintenance deleted');
  } catch(err){ console.error(err); alert('Delete failed'); }
}

/* ===========================
   Charts rendering
   =========================== */
function renderCharts(){
  const byCat = {};
  const now = new Date();
  assets.forEach(a => {
    const cat = a.category || 'Uncategorized';
    byCat[cat] = (byCat[cat] || 0) + computeBookValue(a, now);
  });
  const labels = Object.keys(byCat);
  const values = labels.map(l => byCat[l]);

  // donut
  const dCtx = document.getElementById('categoryDonut').getContext('2d');
  if(donutChart) donutChart.destroy();
  donutChart = new Chart(dCtx, { type:'doughnut', data:{ labels, datasets:[{ data: values, backgroundColor: ['#2a9df4','#17a2b8','#34d399','#f59e0b','#7c3aed','#ef4444'] }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });

  // line over time - simple yearly book value totals (last 6 years)
  const years = Array.from({length:6}, (_,i)=> (new Date().getFullYear() - (5 - i)));
  const series = years.map(y => {
    const d = new Date(y,11,31);
    return assets.reduce((s,a)=> s + computeBookValue(a, d), 0);
  });
  const lCtx = document.getElementById('bookValueLine').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lCtx, { type:'line', data:{ labels: years.map(String), datasets:[{ label:'Total Book Value', data: series, borderColor:'#2a9df4', backgroundColor:'rgba(42,157,244,0.08)', tension:0.3 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ ticks:{ callback: v => '$' + v.toLocaleString() } } } } });
}

/* ===========================
   Exports
   =========================== */
async function exportAssetsExcel(){
  try {
    const arr = assets.map(a => ({ id:a.id, name:a.name, tag:a.tag, category:a.category, purchaseValue:a.purchaseValue, salvageValue:a.salvageValue, usefulLife:a.usefulLife, deprMethod:a.deprMethod, status:a.status, department:a.department, location:a.location }));
    const ws = XLSX.utils.json_to_sheet(arr);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Assets');
    XLSX.writeFile(wb, 'assets.xlsx');
    logActivity('Exported assets to Excel');
  } catch(err){ console.error(err); alert('Export failed'); }
}

async function exportAssetsPDF(){
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    doc.setFontSize(14); doc.text('Assets Report — BlueFactory', 14, 16);
    doc.setFontSize(10);
    let y = 24;
    doc.text('Name', 14, y); doc.text('Category', 80, y); doc.text('Purchase', 130, y);
    y += 6;
    for(const a of assets){
      if(y > 280){ doc.addPage(); y = 20; }
      doc.text(a.name || '', 14, y); doc.text(a.category || '', 80, y); doc.text('$' + (a.purchaseValue||0), 130, y);
      y += 6;
    }
    doc.save('assets.pdf');
    logActivity('Exported assets to PDF');
  } catch(err){ console.error(err); alert('PDF export failed'); }
}

/* ===========================
   Filters & events
   =========================== */
function populateCategoryFilter(){
  const cats = [...new Set(assets.map(a=>a.category).filter(Boolean))].sort();
  filterCategory.innerHTML = '<option value="">All categories</option>';
  cats.forEach(c => filterCategory.insertAdjacentHTML('beforeend', `<option value="${esc(c)}">${esc(c)}</option>`));
}
filterCategory.addEventListener('change', ()=> { currentPage = 0; renderAssets(); });
filterStatus.addEventListener('change', ()=> { currentPage = 0; renderAssets(); });
showDisposed.addEventListener('change', ()=> { currentPage = 0; renderAssets(); });
globalSearch.addEventListener('input', ()=> { currentPage = 0; renderAssets(); });

/* ===========================
   Modal root close helper
   =========================== */
function closeModal(){
  document.getElementById('modalRoot').innerHTML = '';
  document.getElementById('modalRoot').style.display = 'none';
}

/* ===========================
   Initial load
   =========================== */
loadAssets();

/* ===========================
   Optional: realtime updates (commented)
   =========================== */
// db.collection('assets').onSnapshot(snapshot => {
//   assets = [];
//   snapshot.forEach(doc => assets.push({ id: doc.id, ...doc.data() }));
//   renderAssets(); populateCategoryFilter(); renderCharts();
//   logActivity('Assets updated (realtime)');
// });

</script>
</body>
</html>
